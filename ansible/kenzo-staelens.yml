---
- name: Disable ubuntu IPv6
  become: true
  hosts: all
  tasks:
    - name: Disable ipv6
      ansible.posix.sysctl:
        name: "{{ item }}"
        value: "1"
        reload: true
      loop:
        - net.ipv6.conf.all.disable_ipv6
        - net.ipv6.conf.default.disable_ipv6
        - net.ipv6.conf.lo.disable_ipv6

- name: Install docker & workable ansible env
  hosts: all
  become: true
  roles:
    - common

- name: Build and push images
  hosts: controllers
  gather_facts: false
  become: true
  tasks:
    - name: Push (force) latest image
      containers.podman.podman_image:
        path: "{{ root }}/ansible/docker_webserver"
        name: registry.gitlab.com/ikdoeict/kenzo.staelens/2223-iac_docker_project-staelens-kenzo/webserver
        tag: flask-iac
        force: true # updates worden zonder force niet gepusht
        push: true
        state: build
        push_args:
          dest: registry.gitlab.com/ikdoeict/kenzo.staelens/2223-iac_docker_project-staelens-kenzo/webserver

- name: Run webservers
  hosts: webservers
  become: true
  roles:
    - webhosts

- name: Run Loadbalancer
  hosts: loadbalancers
  become: true
  roles:
    - loadbalancer

- name: Print links
  hosts: localhost
  become: false
  tasks:
    - name: Print links
      ansible.builtin.debug:
        msg: "{{ stage + '_' + hostvars[item]['inventory_hostname'] }}: \
        https://{{ hostvars[item]['ansible_host'] }}:{{ 8000 if item in groups['loadbalancers'] else 8001 }}"
      with_items:
        - "{{ groups['loadbalancers'] + groups['webservers'] }}"
